\chapter{Discontinuous Galerkin Spectral Element Method} \label{chapter:spectral_element_method} 
We will use the discontinuous Galerkin spectral element method to solve this problem. This method is
part of the broader spectral methods, with elements from finite-element methods. This method has the
exponential convergence of spectral methods, and the ability to model difficult geometries of
finite-element methods. This method and a way to efficiently translate it to computer code is
described in~\cite{Kopriva2009}. We use this method to solve the 2D wave equation. The main problem
showcased through this work depicts a wave moving diagonally through a square domain.

\section{Spectral approximation} \label{section:spectral_element_method:spectral_approximation}
% Legendre polynomials, both forms
% Polynomial interpolation

Spectral methods, as described by Gotlieb and Orszag~\cite{Gottlieb1977}, model functions as sums of
weighed orthogonal polynomials. $\phi_n(x)$ is the polynomial of degree $n$, and $a_n$ is the weight
of said polynomial. The weights make up the spectrum of the solution.

\begin{equation} \label{equ:infinite_sum}
    \begin{split}
        f(x) & = \sum_{n = 0}^{\infty }a_n \phi_n(x)
    \end{split}
\end{equation}

Since it is impractical to sum an infinite number of polynomials on a computer, the sum is truncated
to a polynomial order $N$. This becomes the polynomial order of the approximation. The truncated
part becomes $\tau$, the truncation error.

\begin{equation} \label{equ:truncated_sum}
    \begin{split}
        f(x) & = \sum_{n = 0}^{\infty }a_n \phi_n(x) \\
        & = \sum_{n = 0}^{N}a_n \phi_n(x) + \sum_{n = N + 1}^{\infty }a_n \phi_n(x) \\
        & = \sum_{n = 0}^{N}a_n \phi_n(x) + \tau \\
        & \approx \sum_{n = 0}^{N}a_n \phi_n(x)
    \end{split}
\end{equation}

Since we discard part of the spectrum is discarded, it is important that the most important part of
the spectrum is in the lower order polynomials. We want the weights to decay as fast as possible.
This will be a characteristic of the polynomials we choose. For example, Fourier series, Legendre
polynomials and Chebyshev polynomials have been proved~\cite{Kopriva2009} to have exponentially
decaying coefficient, giving them spectral accuracy.

\subsection{Basis functions} \label{section:spectral_element_method:spectral_approximation:basis_functions}
Polynomials used in spectral methods need to be orthogonal in the studied domain. For orthogonal
functions in the domain $[a, b]$, we have:

\begin{equation} \label{equ:orthogonality}
	\int_{a}^{b}\phi_i(x) \phi_j(x)dx = C_i \delta_{ij}
\end{equation}

With $C_i$ being a constant, and $\delta_{ij}$ being the Kronecker delta, defined as such:

\begin{equation} \label{equ:kronecker}
	\delta _{ij} = \left\{ \begin{matrix}
                    1, & if \:\: i = j,\\ 
                    0, & if \:\: i \neq j.
                    \end{matrix} \right.
\end{equation}

The inner product $V = L^2 \left( a, b \right)$, with $V$ being a vector space over $\mathbb{R}$ and
$f \left( x \right)$ and $g \left( x \right)$ being two continuous function in $\left[ a, b
\right]$, is:

\begin{equation}
    \left( f, g \right) = \int_{a}^{b}f(x)g(x)dx
\end{equation}

We can therefore rewrite Equation~\ref{equ:orthogonality} in inner product form:

\begin{equation}
	\left( \phi_i, \phi_j \right) = \int_{a}^{b}\phi_i(x) \phi_j(x)dx = C_i \delta_{ij}
\end{equation}

The high-order orthogonal polynomials we use have associated weights $w$:

\begin{equation}
	\left ( \phi_i, \phi_j \right ) = \int_a^b \phi_i(x)\phi_j(x)w(x)dx = D_{ij}\delta_{ij}
\end{equation}

We added $w(x)$, the weight function ensuring the orthogonality of the polynomials. $D_{ij}$ is a
constant. 

Fourier series can be used for periodic problems. As for non-periodic problems, Legendre polynomials
and Chebyshev polynomials fit these criteria. Legendre polynomial have a a weight function of $w(x)
= 1$, which simplifies computations. We will therefore use the Legendre polynomials.

\begin{figure}[H]
	\centering
	\includesvg[width=0.8\textwidth]{Chapter_spectral_element_method/media/polynomials}
	\caption{Legendre polynomials: The first 6 Legendre polynomials.}
	\label{fig:polynomials}
\end{figure}

The Legendre polynomials were discovered by Adrien-Marie Legendre in 1782. With their associated
weights $w(x) = 1$ and in the interval $\left[ -1, 1 \right]$, the polynomials are orthogonal. The
Legendre polynomials $L_k \left( x \right)$ of degree $k$ therefore have the property:

\begin{equation}
	\int_{-1}^{1}L_{k_1}(x) L_{k_2}(x) dx = 0, \quad if \:\: k_1 \neq k_2
\end{equation}

The Legendre polynomials can be generated using a three-term recursive formula. Knowing that the
first two polynomials are $L_0 \left( x \right) = 1$ and $L_1 \left( x \right) = x$, all subsequent
polynomials can be generated.

\begin{equation} \label{equ:three_terms}
	L_{k + 1}(x) = \frac{2k + 1}{k + 1}xL_k(x) - \frac{k}{k + 1}L_{k - 1}(x)
\end{equation}

These polynomials will help us solve integrals using Gauss quadrature. For an interval $\left[ -1, 1
\right]$, the Gauss quadrature is:

\begin{equation}
	\int_{-1}^{1}f(x)dx \approx \sum_{i = 0}^{N}w_i f(x_i)
\end{equation}

The points $x_i$ used for the quadrature are the Gauss quadrature points, or collocation points.
Using the roots of the (N + 1)\textsuperscript{th} Legendre polynomial, the quadrature is exact for
polynomials of degree $\leq 2 N + 1$. This is the \textit{Gauss-Legendre quadrature rule}. We use
the roots of the (N + 1)\textsuperscript{th} Legendre polynomial to get the positions $x_i$ and
weights $w_i$.

\begin{gather}
	x_i = roots \:\: of \:\: L_{N + 1}(x), \quad i = 0, ..., N \\
	w_i = \frac{2}{(1-x_i^2)\left [ L'_{N + 1}(x_i) \right ]^2}
\end{gather}

\subsection{Polynomial interpolation} \label{section:spectral_element_method:spectral_approximation:polynomial_interpolation}
Polynomial interpolation interpolates data along a polynomial passing through known points. The
polynomial has an order equal to the number of points. In this work we use Lagrange integrating
polynomials $l_j$ of degree N.

\begin{equation}
	l_j(x) = \prod_{\substack{i = 0 \\ i \neq j}}^{N}\frac{x- x_i}{x_j - x_i}
\end{equation}

At each collocation point $x_i$ only one of the integrating polynomials has the value 1, the others
having a value of 0. This mimics the Kronecker delta $\delta_{ij}$.

\begin{equation}
	l_j(x_i) = \delta_{ij} = \left\{\begin{matrix}
	1, \quad i = j\\ 
	0, \quad i \neq j,
	\end{matrix}\right.
\end{equation}

The following figure displays the interpolating polynomials of degree 6:

\begin{figure}[H]
	\centering
	\includesvg[width=0.8\textwidth]{Chapter_spectral_element_method/media/interpolants}
	\caption{Polynomial interpolation: The Lagrange integrating polynomials of degree 6.}
	\label{fig:interpolants}
\end{figure}

With this, we can interpolate a function $p_N \left( x \right)$ of degree N:

\begin{equation}
	p_N(x) = \sum_{j = 0}^{N}p(x_j)l_j(x)
\end{equation}

We can also modify the Lagrange interpolation to the barycentric form.

\begin{gather}
	p_N(x) = \psi(x)\sum_{j = 0}^{N}p(x_j)\frac{w_j}{x - x_j} \\
	\psi(x) = \prod_{i = 0}^{N}\left ( x - x_i \right ) \\
	w_j = \frac{1}{\prod_{\genfrac{}{}{0pt}{2}{i = 0}{i \neq j}}^{N}(x_j - x_i)}
\end{gather}

We retain the same property as the initial form:

\begin{equation}
	\psi(x)\sum_{j = 0}^{N}\frac{w_j}{x - x_j} = 1.
\end{equation}

We can then rewrite the complete Lagrange interpolation in barycentric form. By pre-computing the
barycentric weights $w_j$, we can compute the interpolated value at any point $x$ using only the
known values at the collocation points, without computing the interpolating polynomials. 

\begin{equation}
	p_N(x) = \frac{\sum_{j = 0}^{N} p(x_j)\frac{w_j}{x - x_j}}{\sum_{j = 0}^{N}\frac{w_j}{x - x_j}}
\end{equation}

\section{Equation} \label{section:spectral_element_method:equation}
We want to solve the 2D wave equation:

\begin{gather}
	\frac{\partial^2p}{\partial t^2} - c^2(p_{xx} + p_{yy}) = 0 \\
	u_t = - p_x \\
	v_t = -p_y
\end{gather}

With $p$ being the pressure, $u$ and $v$ being the two components of the velocity, and $c$ being the
sound speed. The three equations can be combined into one.

\begin{equation} \label{equ:2d_wave}
	\frac{\partial^2p}{\partial t^2} + c^2\left ( (u_x)_t + (v_y)_t \right ) = 0
\end{equation}

We then integrate once with regards to time, to get:

\begin{equation} \label{equ:2d_wave_integrated}
	p_t + c^2\left ( u_x + v_y \right ) = 0
\end{equation}

We can also write Equation~\ref{equ:2d_wave_integrated} in matrix form,

\begin{equation} \label{equ:2d_wave_matrix}
	\begin{bmatrix}
        p \\ 
        u \\ 
        v
	\end{bmatrix}_t +
	\begin{bmatrix}
        0 & c^2 & 0 \\ 
        1 & 0 & 0 \\ 
        0 & 0 & 0
	\end{bmatrix}
	\begin{bmatrix}
        p\\ 
        u\\ 
        v
	\end{bmatrix}_x + 
	\begin{bmatrix}
        0 & 0 & c^2 \\ 
        0 & 0 & 0 \\ 
        1 & 0 & 0
	\end{bmatrix}
	\begin{bmatrix}
        p\\ 
        u\\ 
        v
	\end{bmatrix}_y = 0
\end{equation}

or in vector form.

\begin{equation} \label{equ:2d_wave_vector}
	\overrightarrow{q_t} + B \overrightarrow{q_x} + C \overrightarrow{q_y} = 0
\end{equation}

$B$ and $C$ are constant matrices, and as such can be combined with the derivatives.

\begin{gather}
	\overrightarrow{f} = B \overrightarrow{q} \\
	\overrightarrow{g} = C \overrightarrow{q}
\end{gather}

\begin{equation}
	\overrightarrow{q_t} + \overrightarrow{f_x} + \overrightarrow{g_y} = 0
\end{equation}

By combining $\overrightarrow{f}$ and $\overrightarrow{g}$ into a flux vector $\mathfrak{F}$, we get 
the conservative form of the wave equation.

\begin{equation} \label{equ:2d_wave_fluxes}
	\mathfrak{F} = \overrightarrow{f}\widehat{x} + \overrightarrow{g}\widehat{y}
\end{equation}

Where $\widehat{x}$ and $\widehat{y}$ are the unit vectors in the $x$ and $y$ directions,
respectively. 

\begin{equation} \label{equ:2d_wave_conservation}
	\overrightarrow{q_t} + \bigtriangledown \cdot \mathfrak{F} = 0
\end{equation}

We use the divergence theorem to Equation~\ref{equ:2d_wave_conservation} to obtain two integrals,
one on the control volume $V$ and one on the surface $S$ of said volume.

\begin{equation} \label{equ:2d_wave_integral}
	\frac{d}{dt}\int_{V}\overrightarrow{q}dV = -\int_{S}\mathfrak{F}\cdot \widehat{n}dS. 
\end{equation}

Where $\widehat{n}$ is the surface normal vector, pointing outwards.

\section{DG-SEM} \label{section:spectral_element_method:dg_sem}
Section~\ref{section:spectral_element_method:spectral_approximation} shows how to approximate
functions with polynomials, and how to compute integrals on them. We must then apply those equations
to a domain. Pure spectral approximations apply the polynomials to the whole domain. This can be
problematic when discontinuities or very steep solutions are present, as the finite order
polynomials cannot match the solution, and begin to oscillate. Also, these methods only work for
simple domain shapes, such as quadrilaterals, triangles and circles in 2D. To accommodate more
complex domains, such as channels and airfoils, the method must be modified.

A. Patera proposed using spectral element methods~\cite{Patera1984} to combine the accuracy of
spectral methods and the generality of finite element methods. Finite element methods can model
complex geometries by splitting the domain into multiple elements, with the equations being solved
on the elements. We use the discontinuous Galerkin spectral element method. The DG-SEM uses the 
Gauss quadrature points described in
Subsection~\ref{section:spectral_element_method:spectral_approximation:basis_functions}. The absence
of quadrature points at the edges of the domain lets the different elements be discontinuous at
their boundaries. These discontinuities are then counterbalanced by fluxes between elements. This in
contrast to the continuous Galerkin spectral element method, where the solution is made continuous 
at element boundaries by using the Gauss-Lobatto quadrature points. These quadrature points include
points at $-1$ and $1$. The tradeoff is reduced accuracy.

We start by deriving the discontinuous Galerkin approximation for a simple 2D domain spanning
$\left[ -1, 1 \right] x \left[ -1, 1 \right]$.

\begin{figure}[H]
	\centering
	\includesvg[width=0.6\textwidth]{Chapter_spectral_element_method/media/domain}
	\caption{2D simple domain: $\left[ -1, 1 \right] x \left[ -1, 1 \right]$, with the four normals $n_i$.}
	\label{fig:simple_domain}
\end{figure}

We can now approximate our solutions by polynomials of degree $N$ in both directions, in Lagrange
form. 

\begin{gather}
	\overrightarrow{q} \approx \mathbf{Q} = \sum_{i = 0}^{N}\sum_{j = 0}^{N}\mathbf{Q}_{i,j}l_i(x)l_j(y) \\
	\mathfrak{F} \approx \mathbf{F} = \sum_{i = 0}^{N} \sum_{j = 0}^{N} \left ( \mathbf{F}_{i, j} \widehat{x} + \mathbf{G}_{i, j}\widehat{y}\right ) l_i(x) l_j(y)
\end{gather}

Where $\mathbf{F}_{i, j} \widehat{x} + \mathbf{G}_{i, j}\widehat{y} = B \mathbf{Q}_{i, j}\widehat{x}
+ C \mathbf{Q}_{i, j}\widehat{y}$. 

We rearrange Equation~\ref{equ:2d_wave_conservation} in weak form, using the test functions $v$.

\begin{equation} \label{equ:2d_wave_weak}
	\left( \overrightarrow{q_t}, v \right) + \left( \bigtriangledown \cdot \mathfrak{F}, v \right) = 0
\end{equation}

The test functions themselves can also be rearranged in Lagrange form:

\begin{equation} \label{equ:test_lagrange}
	v = \sum^{N}_{i = 0}\sum_{j = 0}^{N}\widetilde{v}_{i, j}l_i(x)l_j(y)
\end{equation}

We put Equation~\ref{equ:test_lagrange} in~\ref{equ:2d_wave_weak}.

\begin{equation}
	\sum_{i = 0}^{N}\sum_{j = 0}^{N} \left[ \int_{\Omega }\overrightarrow{q_t} l_i(x) l_j(y) dx dy + \int_{\Omega } \left( \bigtriangledown \cdot \mathfrak{F} \right) l_i(x) l_j(y) dx dy \right] \widetilde{v}_{i, j} = 0
\end{equation}

Where $\Omega$ is the whole domain. Since $\widetilde{v}_{i, j}$ are arbitrary, the relation must be
true for all $i,j$ independently. We get:

\begin{gather}
    \int_{\Omega} \overrightarrow{q_t} l_i(x) l_j(y) dx dy + \int_{\Omega } \left( \bigtriangledown \cdot \mathfrak{F} \right) l_i(x) l_j(y) dx dy = 0, \quad i,j = 0, ..., N \\
    \int_{\Omega} \frac{d\mathbf{Q}}{dt} \phi_{i, j} dx dy
    + \int _{\Omega} \bigtriangledown \cdot \mathbf{F} \phi_{i, j} dx dy = 0, \quad i,j = 0, ..., N \label{equ:2d_wave_test}
\end{gather}

With $\phi_{i, j} = l_i(x)l_j(y)$. We can then rewrite Equation~\ref{equ:2d_wave_test} in inner
product form: 

\begin{equation} \label{equ:2d_wave_inner_product}
	\left( \mathbf{Q}_t, \phi_{i, j} \right) + \left( \bigtriangledown \cdot \mathbf{F}, \phi_{i, j} \right) = 0
\end{equation}

We then use Green's first identity to extract the boundary contribution from
Equation~\ref{equ:2d_wave_inner_product}'s second term. Green's first identity goes as follows.

\begin{equation}
    \int_{\Omega} \bigtriangledown \cdot \left( \phi \mathbf{X} \right) d\Omega  = 
    \int_{\Omega} \bigtriangledown \phi \cdot \mathbf{X} + \phi \bigtriangledown \cdot \mathbf{X} d\Omega = \oint _{S} \phi \mathbf{X} \cdot \widehat{n} dS
\end{equation}

Where $\Omega$ is the domain, and $S$ is that domain's boundary. $\phi$ is a scalar function, and
$\mathbf{X}$ is a vector field. $\widehat{n}$ is the boundary's normal vector, pointing outwards.
Applied to Equation~\ref{equ:2d_wave_inner_product}'s second term, we get:

\begin{equation} \label{equ:flux_green}
    \left( \bigtriangledown \cdot \mathbf{F}, \phi_{i, j} \right) = \int_{-1}^{1}\int_{-1}^{1}\phi_{i, j} \bigtriangledown \cdot \mathbf{F} dx dy = \oint_{S}\phi_{i, j} \mathbf{F} \cdot \widehat{n}dS - \int_{-1}^{1}\int_{-1}^{1} \mathbf{F} \cdot \bigtriangledown \phi_{i, j} dx dy
\end{equation}

The complete equation becomes:

\begin{equation} \label{equ:integral_equ}
    \left( \mathbf{Q}_t, \phi_{i, j} \right) + \oint_{S}\phi_{i, j} \mathbf{F}^* \cdot \widehat{n}dS - \int_{-1}^{1}\int_{-1}^{1} \mathbf{F} \cdot \bigtriangledown \phi_{i, j} dx dy = 0.
\end{equation}

The boundary conditions are weakly enforced using fluxes $\mathbf{F}^*$, explained in
Subsection~\ref{section:spectral_element_method:spectral_approximation:dg_sem:fluxes}. 

We then need to evaluate those integrals. A distinction is made between the boundary terms, that are
evaluated using the collocation points within an element, and the boundary term, which uses
collocation points on the element boundaries.

\begin{figure}[H]
	\centering
	\includesvg[width=0.4\textwidth]{Chapter_spectral_element_method/media/nodes}
	\caption{2D simple domain: Interior collocation points in lilac, boundary collocation points in blue.}
	\label{fig:domain_nodes}
\end{figure}

We start by applying the Gauss quadrature to the first term of Equation~\ref{equ:integral_equ}.

\begin{equation}
	\begin{split}
        \int_{-1}^{1}\int_{-1}^{1} \mathbf{Q}_t \phi_{i, j} dx dy 
        &= \int_{-1}^{1}\int_{-1}^{1}\mathbf{Q}_t l_i(x) l_j(y) dx dy \\
        &= \sum_{k = 0}^{N} \sum_{l = 0}^{N}\frac{d\mathbf{Q} \left( x_k, y_l \right)}{dt} l_i(x_k) l_j(y_l) w_k^{(x)} w_l^{(y)}
	\end{split}
\end{equation}

Since the integrand is a polynomial of degree $2 N$, and the Gauss quadrature is exact up to $2 N +
1$, the integral is exact. We use the fact that only one integrating polynomial $l_i$ is equal to 1
and not 0 on each collocation point $x_k$ to get:

\begin{equation} \label{equ:integral_1}
    \int_{-1}^{1}\int_{-1}^{1} \mathbf{Q}_t \phi_{i, j} dx dy 
    = \frac{d\mathbf{Q} \left( x_i, y_j \right)}{dt} w_i^{(x)} w_j^{(y)}.
\end{equation}

We do the same fon the third term of Equation~\ref{equ:integral_equ}.

\begin{equation} \label{equ:integral_3}
	\begin{split}
		\int_{-1}^{1}\int_{-1}^{1}\mathbf{F} \cdot \bigtriangledown \phi_{i, j} dx dy 
		&= \int_{-1}^{1}\int_{-1}^{1}\mathbf{F}(x, y) l'_i(x)l_j(y) + \mathbf{G}(x, y) l_i(x) l'_j(y) \:\: dx dy \\ 
		&= \sum_{k = 0}^{N} \sum_{l = 0}^{N}\left [ \mathbf{F}(x_k, y_l)l'_i(x_k)l_j(y_l) + \mathbf{G}(x_k, y_l) l_i(x_k)l'_j(y_l) \right ]w_k^{(x)} w_l^{(y)} \\
		&= \sum_{k = 0}^{N} \mathbf{F}(x_k, y_j)l'_i(x_k)w_k^{(x)} w_j^{(y)} + \sum_{l = 0}^{N}\mathbf{G}(x_i, y_l) l'_j(y_l) w_i^{(x)} w_l^{(y)}.
	\end{split}
\end{equation}

Now only the second term is left, the integral over the boundary. We start by applying the Gauss
quadrature to the developed integral.

\begin{equation} \label{equ:integral_2}
	\begin{split}
        \oint_{S} \phi_{i, j}\mathbf{F}^* \cdot \widehat{n}dS = & 
        \int_{-1}^{1}l_i(x) l_j(-1)\mathbf{F}^*(x, -1) \cdot (-\widehat{y}) \: dx \\
        & + \int_{-1}^{1}l_i(x) l_j(1)\mathbf{F}^*(x, 1) \cdot (\widehat{y}) \: dx \\
        & + \int_{-1}^{1}l_i(-1) l_j(y)\mathbf{F}^*(-1, y) \cdot (-\widehat{x}) \: dy \\
        & + \int_{-1}^{1}l_i(1) l_j(y)\mathbf{F}^*(1, y) \cdot (\widehat{x}) \: dy \\
        = & \sum_{k = 0}^{N}l_i(x_k)l_j(-1)\mathbf{F}^*(x_k, -1)\cdot (-\widehat{y}) \: w_k^{(x)} \\
        & + \sum_{k = 0}^{N}l_i(x_k)l_j(1)\mathbf{F}^*(x_k, 1)\cdot (\widehat{y}) \: w_k^{(x)} \\
        & + \sum_{l = 0}^{N}l_i(-1)l_j(y_l)\mathbf{F}^*(-1, y_l)\cdot (-\widehat{x}) \: w_l^{(y)} \\
        & + \sum_{l = 0}^{N}l_i(1)l_j(y_l)\mathbf{F}^*(1, y_l)\cdot (\widehat{x}) \: w_l^{(y)} \\
        = & l_j(-1)\mathbf{F}^*(x_i, -1)\cdot (-\widehat{y}) \: w_i^{(x)} \\
        & + l_j(1)\mathbf{F}^*(x_i, 1)\cdot (\widehat{y}) \: w_i^{(x)} \\
        & + l_i(-1)\mathbf{F}^*(-1, y_j)\cdot (-\widehat{x}) \: w_j^{(y)} \\
        & + l_i(1)\mathbf{F}^*(1, y_j)\cdot (\widehat{x}) \: w_j^{(y)}
	\end{split}
\end{equation}

Note that the integrands are also of order $2 N$, and are computed exactly. We put
Equations~\ref{equ:integral_1}, ~\ref{equ:integral_2} and ~\ref{equ:integral_3} in
Equation~\ref{equ:integral_equ} and divide by the weights $w_i^{ \left( x \right) } w_j^{ \left( y \right) }$.

\begin{equation} \label{equ:2d_wave_full}
	\begin{split}
        & \frac{d\mathbf{Q}(x_i, y_j)}{dt} \\
        & + \left\{ \left[ l_i \left( -1 \right) \mathbf{F}^* \left( -1, y_j \right) \cdot \left( -\widehat{x} \right) \frac{1}{w_i^{ \left( x \right) }} + l_i \left( 1 \right) \mathbf{F}^* \left( 1, y_j \right) \cdot
        \left( \widehat{x} \right) \frac{1}{w_i^{ \left( x \right) }} \right] - \sum_{k = 0}^{N} \mathbf{F} \left(x_k, y_j \right) \frac{l'_i \left( x_k \right) w_k^{ \left( x \right) }}{w_i^{ \left( x \right) }} \right\} \\
        & + \left\{ \left[ l_j \left( -1 \right) \mathbf{F}^* (x_i, -1) \cdot \left( -\widehat{y} \right) \frac{1}{w_j^{ \left( y \right) }} + l_j \left( 1 \right) \mathbf{F}^*(x_i, 1) \cdot
        \left( \widehat{y} \right) \frac{1}{w_j^{ \left( y \right) }} \right] - \sum_{l = 0}^{N} \mathbf{G} \left(x_i, y_l \right) \frac{l'_j \left( y_l \right) w_l^{ \left( y \right) }}{w_j^{ \left( y \right) }} \right\} \\
        & = 0, \quad i,j = 0, ..., N
	\end{split} 
\end{equation}

We define $l'_i(x_k)$ as the derivative matrix $D_{k, i}$. Since they are constant, we also
incorporate the weights $w_i$ and $w_k$.

\begin{equation} \label{equ:d_hat}
	\begin{split}
        \widehat{D}_{i,k} = & -\frac{D_{k, i} w_k}{w_i} \\
        = & -\frac{l'_i(x_k) w_k}{w_i}
	\end{split} 
\end{equation}

This simplifies Equation~\ref{equ:2d_wave_full} to:

\begin{equation} \label{equ:2d_wave_d}
	\begin{split}
        & \frac{d\mathbf{Q}(x_i, y_j)}{dt} \\
        & + \left\{ \left[ l_i \left( -1 \right) \mathbf{F}^* \left( -1, y_j \right) \cdot \left( -\widehat{x} \right) \frac{1}{w_i^{ \left( x \right) }} + l_i \left( 1 \right) \mathbf{F}^* \left( 1, y_j \right) \cdot
        \left( \widehat{x} \right) \frac{1}{w_i^{ \left( x \right) }} + \sum_{k = 0}^{N} \mathbf{F} \left( x_k, y_j \right) \widehat{D}_{i, k}^{ \left( x \right) } \right] \right\} \\
        & + \left \{ \left [ l_j \left( -1 \right) \mathbf{F}^* \left( x_i, -1 \right) \cdot \left( -\widehat{y} \right) \frac{1}{w_j^{ \left( y \right) }} + l_j \left( 1 \right) \mathbf{F}^* \left(x_i, 1 \right) \cdot
        \left( \widehat{y} \right) \frac{1}{w_j^{ \left( y \right) }} + \sum_{l = 0}^{N} \mathbf{G} \left( x_i, y_l \right) \widehat{D}_{j, l}^{ \left( y \right) } \right] \right\} \\
        & = 0, \quad i, j = 0, ..., N
	\end{split}
\end{equation}

The collocation points, weights and derivative matrices from Equation~\ref{equ:2d_wave_d} can be
computed directly and stored for the whole computation. Algorithms for those are discussed in
Section~\ref{section:spectral_element_method:implementation}. The next section discusses the
computation of the fluxes $\mathbf{F}^*$.

\subsection{Fluxes} \label{section:spectral_element_method:spectral_approximation:dg_sem:fluxes}

We now need to compute the numerical fluxes $\mathbf{F}^*$ as a way to approximate the physical
fluxes $\mathfrak{F}$. We recall the formulation for the fluxes from
Equation~\ref{equ:2d_wave_fluxes}. 

\begin{equation} \label{equ:physical_fluxes}
	\mathfrak{F} = \overrightarrow{f_x} + \overrightarrow{g_y} = B \overrightarrow{q_x} + C \overrightarrow{q_y}
\end{equation}

With matrices $B$ and $C$ taken from Equation~\ref{equ:2d_wave_matrix}.

\begin{equation}
	B = \begin{bmatrix}
        0 & c^2 & 0 \\ 
        1 & 0 & 0 \\ 
        0 & 0 & 0 
	\end{bmatrix}
	C = \begin{bmatrix}
        0 & 0 & c^2\\ 
        0 & 0 & 0 \\ 
        1 & 0 & 0
	\end{bmatrix}
\end{equation}

We will use an upwind scheme~\cite{Toro2009} to impose the boundary conditions. On an interface
between two elements, the left and right elements in that coordinate system, the state at the
interface is the left state if the wave goes from left to right, or the right state if the wave goes
from right to left. This is the upwind state of the boundary.

Since it is not evident what the upwind state of the system described in
Equation~\ref{equ:physical_fluxes}, we will decouple the wave components. We start with the $x$
direction, decomposing $B$ to a diagonal matrix $\Lambda_B$, its right eigenvectors $K_B$, and their
inverse $K_B^{-1}$.

\begin{equation}
    \Lambda_B = 
    \begin{bmatrix}
        c & 0 & 0 \\ 
        0 & -c & 0 \\ 
        0 & 0 & 0
    \end{bmatrix}
    K_B = 
    \begin{bmatrix}
        c & -c & 0 \\ 
        1 & 1 & 0 \\ 
        0 & 0 & 1 
    \end{bmatrix}
    K_B^{-1} = 
    \begin{bmatrix}
        \frac{1}{2c} & \frac{1}{2} & 0 \\ 
        -\frac{1}{2c} & \frac{1}{2} & 0 \\ 
        0 & 0 & 1
    \end{bmatrix}
\end{equation}

The diagonal matrix can be further decomposed into three wave directions: left-to-right,
right-to-left, and stationary.

\begin{equation}
	\begin{split}
		\Lambda_B & = 
        \begin{bmatrix}
            c & 0 & 0 \\ 
            0 & -c & 0 \\ 
            0 & 0 & 0
		\end{bmatrix} = 
		\begin{bmatrix}
            c & 0 & 0 \\ 
            0 & 0 & 0 \\ 
            0 & 0 & 0
		\end{bmatrix} +
		\begin{bmatrix}
            0 & 0 & 0 \\ 
            0 & -c & 0 \\ 
            0 & 0 & 0
		\end{bmatrix} +
		\begin{bmatrix}
            0 & 0 & 0 \\ 
            0 & 0 & 0 \\ 
            0 & 0 & 0
		\end{bmatrix} \\
		&= \Lambda_B^+ + \Lambda_B^- + \Lambda_B^0
	\end{split}
\end{equation}

\subsection{Time integration} \label{section:spectral_element_method:spectral_approximation:dg_sem:time}

\section{Implementation} \label{section:spectral_element_method:implementation}
% Talk about the flux computation, possible race conditions
